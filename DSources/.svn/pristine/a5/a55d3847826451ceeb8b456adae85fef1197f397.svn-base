using System;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using System.Collections.Generic;
using NMock2;
using DSources.Parsers;

namespace DSources.Logic
{
    [TestClass]
    public class ParsersLoaderTest
    {
        [TestMethod]
        [TestCategory("ParsersLoader")]
        [TestCategory("Implemented")]
        public void TestLoadInvalidParser()
        {
            Mockery mockery = new Mockery();

            MyType typeMock = (MyType)mockery.NewMock(typeof(MyType));
            Expect.AtLeast(1).On(typeMock).GetProperty("IsFinal").Will(Return.Value(true));
            Expect.Never.On(typeMock).GetProperty("DefaultConstructor");

            ICollection<MyType> typeCollection = new LinkedList<MyType>();
            typeCollection.Add(typeMock);

            ParsersLoader testedLoader = new ParsersLoader();

            ICollection<Parser> loadedParsers = testedLoader.LoadParsers(typeCollection);

            Assert.IsTrue(loadedParsers.Count == 0);

            mockery.VerifyAllExpectationsHaveBeenMet();
        }


        [TestMethod]
        [TestCategory("ParsersLoader")]
        [TestCategory("Implemented")]
        public void TestLoadValidParser()
        {
            Mockery mockery = new Mockery();

            Parser parserMock = (Parser) mockery.NewMock(typeof(Parser));

            MyConstructor constructorMock = (MyConstructor)mockery.NewMock(typeof(MyConstructor));
            Expect.AtLeast(1).On(constructorMock).Method("Invoke").WithAnyArguments().Will(Return.Value(parserMock));

            MyType typeMock = (MyType)mockery.NewMock(typeof(MyType));
            Expect.AtLeast(1).On(typeMock).GetProperty("IsFinal").Will(Return.Value(false));
            Expect.AtLeast(1).On(typeMock).GetProperty("DefaultConstructor").Will(Return.Value(constructorMock));

            ICollection<MyType> typeCollection = new LinkedList<MyType>();
            typeCollection.Add(typeMock);

            ParsersLoader testedLoader = new ParsersLoader();

            ICollection<Parser> loadedParsers = testedLoader.LoadParsers(typeCollection);

            Assert.IsTrue(loadedParsers.Count==1);
            Assert.IsTrue(loadedParsers.Contains(parserMock));

            mockery.VerifyAllExpectationsHaveBeenMet();
        }

        [TestMethod]
        [TestCategory("ParsersLoader")]
        [TestCategory("Implemented")]
        public void TestLoadValidMoreParsers()
        {
            Mockery mockery = new Mockery();
            ParsersLoader testedLoader = new ParsersLoader();

            Parser parserMock = (Parser)mockery.NewMock(typeof(Parser));

            MyConstructor constructorMock = (MyConstructor)mockery.NewMock(typeof(MyConstructor));
            Expect.AtLeast(1).On(constructorMock).Method("Invoke").WithAnyArguments().Will(Return.Value(parserMock));

            MyType typeMock = (MyType)mockery.NewMock(typeof(MyType));
            Expect.AtLeast(1).On(typeMock).GetProperty("IsFinal").Will(Return.Value(false));
            Expect.AtLeast(1).On(typeMock).GetProperty("DefaultConstructor").Will(Return.Value(constructorMock));


            ICollection<MyType> typeCollection = new LinkedList<MyType>();
            typeCollection.Add(typeMock);

            ICollection<Parser> loadedParsers = testedLoader.LoadParsers(typeCollection);

            Assert.IsTrue(loadedParsers.Count == 1);
            Assert.IsTrue(loadedParsers.Contains(parserMock));
            mockery.VerifyAllExpectationsHaveBeenMet();


            Parser parserMock2 = (Parser)mockery.NewMock(typeof(Parser));

            MyConstructor constructorMock2 = (MyConstructor)mockery.NewMock(typeof(MyConstructor));
            Expect.AtLeast(1).On(constructorMock2).Method("Invoke").WithAnyArguments().Will(Return.Value(parserMock2));

            MyType typeMock2 = (MyType)mockery.NewMock(typeof(MyType));
            Expect.AtLeast(1).On(typeMock2).GetProperty("IsFinal").Will(Return.Value(false));
            Expect.AtLeast(1).On(typeMock2).GetProperty("DefaultConstructor").Will(Return.Value(constructorMock2));


            typeCollection.Add(typeMock2);

            loadedParsers = testedLoader.LoadParsers(typeCollection);

            Assert.IsTrue(loadedParsers.Count == 2);
            Assert.IsTrue(loadedParsers.Contains(parserMock));
            Assert.IsTrue(loadedParsers.Contains(parserMock2));
            mockery.VerifyAllExpectationsHaveBeenMet();
        }

        [TestMethod]
        [TestCategory("ParsersLoader")]
        [TestCategory("Implemented")]
        public void TestLoadMoreValidParsersWithOneInvalid()
        {
            Mockery mockery = new Mockery();
            ParsersLoader testedLoader = new ParsersLoader();

            Parser parserMock = (Parser)mockery.NewMock(typeof(Parser));

            MyConstructor constructorMock = (MyConstructor)mockery.NewMock(typeof(MyConstructor));
            Expect.AtLeast(1).On(constructorMock).Method("Invoke").WithAnyArguments().Will(Return.Value(parserMock));

            MyType typeMock = (MyType)mockery.NewMock(typeof(MyType));
            Expect.AtLeast(1).On(typeMock).GetProperty("IsFinal").Will(Return.Value(false));
            Expect.AtLeast(1).On(typeMock).GetProperty("DefaultConstructor").Will(Return.Value(constructorMock));

            Parser parserMock2 = (Parser)mockery.NewMock(typeof(Parser));

            MyConstructor constructorMock2 = (MyConstructor)mockery.NewMock(typeof(MyConstructor));
            Expect.AtLeast(1).On(constructorMock2).Method("Invoke").WithAnyArguments().Will(Return.Value(parserMock2));

            MyType typeMock2 = (MyType)mockery.NewMock(typeof(MyType));
            Expect.AtLeast(1).On(typeMock2).GetProperty("IsFinal").Will(Return.Value(false));
            Expect.AtLeast(1).On(typeMock2).GetProperty("DefaultConstructor").Will(Return.Value(constructorMock2));

            MyType invalidMock = (MyType)mockery.NewMock(typeof(MyType));
            Expect.AtLeast(1).On(invalidMock).GetProperty("IsFinal").Will(Return.Value(true));
            Expect.Never.On(invalidMock).GetProperty("DefaultConstructor");



            ICollection<MyType> typeCollection = new LinkedList<MyType>();
            typeCollection.Add(typeMock);
            typeCollection.Add(typeMock2);
            typeCollection.Add(invalidMock);

            ICollection<Parser> loadedParsers = testedLoader.LoadParsers(typeCollection);

            Assert.IsTrue(loadedParsers.Count == 2);
            Assert.IsTrue(loadedParsers.Contains(parserMock));
            Assert.IsTrue(loadedParsers.Contains(parserMock2));
            mockery.VerifyAllExpectationsHaveBeenMet();
        }
    }
}
